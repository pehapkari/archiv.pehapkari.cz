<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Otevřené místo pro všechny PHP programátory">
<meta name="keywords" content="PHP, komunita, programování, srazy, školení, blog, články">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/assets/images/meetup.jpg">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap&subset=latin-ext" rel="stylesheet">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<link href="/favicon.ico" rel="shortcut icon">

<title>
     Domain-Driven Design, part 5 - Repository | Děláš v PHP? Jsi jedním z nás
</title>

<link rel="stylesheet" href="/build/css/app.css">

<link rel="stylesheet" href="/assets/prism/prism.css">
<link rel="stylesheet" href="/assets/prism/prism-custom.css">

<link rel="stylesheet" href="https://use.typekit.net/jmg2upk.css">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i|Ubuntu+Mono&amp;subset=latin-ext" rel="stylesheet">

        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    </head>

    <body id="">
        <nav id="ph-nav" class="navbar fixed-top navbar-expand navbar-light bg-light ph-nav border-bottom hidden-sm-down">
    <div class="container">
        <a class="ph-nav__logo" href="/">
            <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
            <br>
            <p>Péhápkaři</p>
        </a>

        <div id="top-menu-search" class="hidden-md-down">
            <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="pehapkari.cz" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Napiš co hledáš..." autocomplete="off"/>
</form>
        </div>

        <ul class="navbar-nav ml-auto hidden-sm-down" id="menu">
            <li>
                <a class="active" href="/blog">
                    Blog
                </a>
            </li>
            <li>
                <a class="" href="/prehaj-si-prednasku">
                    Videa
                </a>
            </li>
            <li class="pr-0">
                <a class="" href="/kontakt">
                    Kontakt
                </a>
            </li>
        </ul>
    </div>
</nav>

<div id="mobile-menu" class="row ml-0 mr-0 text-center hidden-md-up border-bottom">
    <a href="/" class="ph-nav__logo col-3 ">
        <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
    </a>

    <a href="/prehaj-si-prednasku" class="col-3 ">
        Videa
    </a>
    <a href="/blog" class="col-3 ">
        Blog
    </a>
</div>

                    <div id="main">
                

                    <div class="container" id="article">
        <h1>Domain-Driven Design, part 5 - Repository</h1>

        <strong>Svaťa Šimara</strong>
        &nbsp;
        <time datetime="2018-02-Wed">
            28. 2. 2018
        </time>

        <br>

        <div class="card mt-4 mb-4">
            <div class="card-body text-bigger">
                <p>We will discuss how to store and read domain objects while pretending we have an in-memory system.
Simply, we will show how to implement and test repository.</p>
            </div>
        </div>

        <h2>Collections and Reality</h2>
<p>Let´s imagine that we have a system which runs continually, has enough memory and which is for a single user only.
With this kind of system, we can have all objects in memory collections and everything is shiny.
Memory collections are enough - they allow us to store, receive and remove objects.</p>
<p>But real world is different.
We usually build web applications with request-process-response-die life.</p>
<p><img src="/assets/images/posts/2018/ddd-repository/server-life.png" alt="server receive request, create process, send request and kill process" /></p>
<p>We have to load objects out of persistent memory like a database, work with them and persist them again while the process is done.
This does not reflect the reality where everything run continually, this approach is not domain friendly.</p>
<h2>Repository</h2>
<p>Whole idea is about that we keep pretending that we have collections.
Clever and persistent collections, so-called repositories.
The domain layer would seem to live continually.</p>
<p>Repository, same as a collection, have responsibility to add an object, get objects by identifier or complex criteria and eventually to remove an object.
There are also use cases that require aggregations like <em>How many objects are in the system</em>, <em>Total amount of all products in the warehouse</em>.
For these use cases, the repository can provide direct aggregation methods so we don't have to inefficiently fetch loads of objects.</p>
<p>Repositories are created for aggregates only because aggregates are our building blocks, our units.
They also always work with the whole aggregate, not with an internal part alone, not with a partial aggregate, always with the whole aggregate.</p>
<p>The repository is implemented in the domain layer, because it works with domain objects.
But in the domain layer we should have no idea about any database nor any storage, so the repository is just an interface.</p>
<pre><code class="language-php">// CartRepository.php

namespace Simara\Cart\Domain;

interface CartRepository
{
    public function add(Cart $cart): void;

    /**
     * @throws CartNotFoundException
     */
    public function get(string $id): Cart;

    /**
     * @throws CartNotFoundException
     */
    public function remove(string $id): void;
}</code></pre>
<h3>Persistence Responsibility</h3>
<p>The repository can be responsible for persisting objects.
It would make some sense to have a saving method that instantly persists an object.</p>
<p>But there is no such use case with memory collections so we would have to bring infrastructure requirements into the domain.
If there was a persist operation, we'd have problems with transactions - one object is persisted and second causes an exception while persisting, so what now?</p>
<p>The solution is simple.
Object persistence is not the repository's responsibility.
Someone else is responsible for the persistence.
We can wrap domain use cases into a layer which is responsible for the persistence.</p>
<p>When we use an advanced persistence tool, it usually deals with persistence by flushing an object manager.
But it's still possible to keep references to objects we used and flush them into a storage after the domain use case is done.
This system also allows us to use transactions if the persistence system supports them.</p>
<p><img src="/assets/images/posts/2018/ddd-repository/persistence.png" alt="command is processed by wrapping layer that calls handler and flushes object manager" /></p>
<h2>Concrete Implementation</h2>
<p>We can store domain objects in a relational database, in a document database, in an external system connected by API or in anything else we can imagine.
All these systems are infrastructure for the domain so the repository implementation is in the infrastructure layer.</p>
<h3>Inversion of Dependency</h3>
<p>In an active record persistence pattern and similar patterns, the domain depends on the infrastructure.
But we have created a domain repository interface and the implementation is the infrastructure.
The domain layer is still independent.
For those who like SOLID, everything smoothly fit together.</p>
<h3>Memory Implementation</h3>
<p>The easiest and the most instructive is a memory implementation.
An implementation which just keeps objects during a life and does not persist them at all.</p>
<p>The memory implementation is useful for complex component or module tests.
We integrate more system parts together but we do not use the real repository implementation.
Since everything is in the memory, tests are quick and we still test the whole component or module.</p>
<pre><code class="language-php">// MemoryCartRepository.php

namespace Simara\Cart\Infrastructure;

use Simara\Cart\Domain\Cart;
use Simara\Cart\Domain\CartNotFoundException;
use Simara\Cart\Domain\CartRepository;

class MemoryCartRepository implements CartRepository
{
    /**
     * @var Cart[]
     */
    private $carts = [];

    public function add(Cart $cart): void
    {
        $this-&gt;carts[$cart-&gt;getId()] = $cart;
    }

    public function get(string $id): Cart
    {
        $this-&gt;checkExistence($id);
        return $this-&gt;carts[$id];
    }

    private function checkExistence(string $id): void
    {
        if (!isset($this-&gt;carts[$id])) {
            throw new CartNotFoundException();
        }
    }

    public function remove(string $id): void
    {
        $this-&gt;checkExistence($id);
        unset($this-&gt;carts[$id]);
    }
}</code></pre>
<h2>Interface Test</h2>
<p>We can write tests for the memory implementation and when we integrate a database storage, we can write tests for the database integration.
But these tests can be pretty similar, so we can think of testing the repository interface only.</p>
<p>Basic idea is that the test expects interface implementation.
The test responsibility is not to create the tested object.
Because the test is not responsible for the object creation, it can become simpler.</p>
<p>The furthest I get is that the test is an abstract class and the implementation test extends the abstract test.
I would prefer to have one test with several implementation providers but I didn't find a way to implement this style.
If you have a better idea, please share a comment.</p>
<pre><code class="language-php">// CartRepositoryTest

namespace Simara\Cart\Infrastructure;

use PHPUnit\Framework\Assert;
use PHPUnit\Framework\TestCase;
use Simara\Cart\Domain\Cart;
use Simara\Cart\Domain\CartDetail;
use Simara\Cart\Domain\CartRepository;
use Simara\Cart\Domain\Price;

abstract class CartRepositoryTest extends TestCase
{
    /**
     * @var CartRepository
     */
    private $repository;

    abstract protected function createRepository(): CartRepository;

    protected function setUp()
    {
        $this-&gt;repository = $this-&gt;createRepository();
    }

    protected function flush()
    {
    }

    public function testAddAndGetSuccessfully()
    {
        $cart = new Cart($id);
        $this-&gt;repository-&gt;add($cart);
        $this-&gt;flush();

        $foundCart = $this-&gt;repository-&gt;get('1');
        $expected = new CartDetail([], new Price(0));
        Assert::assertEquals($expected, $foundCart-&gt;calculate());
    }

    // more tests
}</code></pre>
<p>The flush method supplements the persistence and start of a new process life.
The memory implementation doesn't use it and it is prepared for a real persistent repository.</p>
<pre><code class="language-php">// MemoryCartRepositoryTest

namespace Simara\Cart\Infrastructure;

use Simara\Cart\Domain\CartRepository;

class MemoryCartRepositoryTest extends CartRepositoryTest
{
    protected function createRepository(): CartRepository
    {
        return new MemoryCartRepository();
    }
}</code></pre>
<h2>TL;DR</h2>
<p>Repositories are persistent collections and allow us to pretend that the system is in-memory.
The repository works with complete aggregate and is an interface in the domain layer.
The concrete implementation is done by infrastructure which we use.
Tests can be written for the repository interface.</p>
<p>Next time we'll implement a database repository using the Doctrine.</p>
<h2>References</h2>
<p>CLEMSON, Toby.
<em>Testing Strategies in a Microservice Architecture</em> [online].
2014 [2018-01-11].
Available: <a href="https://martinfowler.com/articles/microservice-testing/">https://martinfowler.com/articles/microservice-testing/</a></p>
<p>EVANS, Eric.
<em>Domain-driven design: tackling complexity in the heart of software</em>.
Boston: Addison-Wesley, 2004.
ISBN 0-321-12521-5.</p>
<p>VERNON, Vaughn.
<em>Implementing domain-driven design.</em> Upper Saddle River, NJ: Addision-Wesley, 2013.
ISBN 978-0-321-83457-7.</p>
<h2>Complete code</h2>
<ul>
<li><a href="https://github.com/simara-svatopluk/cart/tree/memory-repository">https://github.com/simara-svatopluk/cart/tree/memory-repository</a> <strong>memory-repository</strong> tag only</li>
</ul>
<h2>Contact</h2>
<p>Are you designing architecture and like DDD approach? Hire me, I can help you - <a href="http://svatasimara.cz/">svatasimara.cz</a></p>

        <br>

        <div class="container">
            <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <br>
    </div>

            </div>
        
        <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <p class="mb-2">Web Péhápkaři.cz pohání <a href="https://symfony.com/">Symfony</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.</p>

                                            </div>

            <div class="col-12 col-md-6 mt-4 mt-md-0">
                <ul id="socials" class="pull-right">
                    <li>
                        <a href="https://facebook.com/pehapkari">
                            <em class="fab fa-2x fa-facebook"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://twitter.com/pehapkari">
                            <em class="fab fa-2x fa-twitter"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/friends-of-php-prague/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Praha</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/Pehapkari-Brno/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Brno</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://github.com/pehapkari">
                            <em class="fab fa-2x fa-github"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ">
                            <em class="fab fa-2x fa-slack"></em>
                        </a>
                        <p>
                            <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ/">
                                <span class="hidden-sm-down">Pozvi se</span>
                                <span class="hidden-md-up">Pozvi</span>
                            </a>
                        </p>
                    </li>
                </ul>
            </div>
        </div>

        <div id="footer_body">
            <div class="row">
                <div class="col-6 col-md-4 mb-4 mb-md-0">
                    <h3>O nás</h3>

                    <ul class="bottom_menu">
                        <li>
                            <a href="/kontakt">Kontakt</a>
                        </li>

                        <li>
                            <a href="/for-speakers">Pro speakry</a>
                        </li>

                        <li>
                            <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/public/assets/pehapkari_logo">Logo</a>
                        </li>

                        <li>
                            <a href="/rss.xml">RSS blogu</a>
                        </li>

                        <li>
                            <a href="http://bit.ly/pehapkari-newsletter">Sleduj Newsletter</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/build/js/app.js"></script>

<script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
<script>
    $('document').ready(function() {
        var typed = new Typed('#typed',{
            stringsElement: '#typed-strings',
            typeSpeed: 50,
            backDelay: 1400,
        });
    });
</script>

<script src="/assets/prism/prism.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
