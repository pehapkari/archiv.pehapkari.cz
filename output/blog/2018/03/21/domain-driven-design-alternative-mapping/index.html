<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Otevřené místo pro všechny PHP programátory">
<meta name="keywords" content="PHP, komunita, programování, srazy, školení, blog, články">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/assets/images/meetup.jpg">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap&subset=latin-ext" rel="stylesheet">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<link href="/favicon.ico" rel="shortcut icon">

<title>
     Domain-Driven Design, part 7 - Alternative Relational Database Mapping | Děláš v PHP? Jsi jedním z nás
</title>

<link rel="stylesheet" href="/build/css/app.css">

<link rel="stylesheet" href="/assets/prism/prism.css">
<link rel="stylesheet" href="/assets/prism/prism-custom.css">

<link rel="stylesheet" href="https://use.typekit.net/jmg2upk.css">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i|Ubuntu+Mono&amp;subset=latin-ext" rel="stylesheet">

        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    </head>

    <body id="">
        <nav id="ph-nav" class="navbar fixed-top navbar-expand navbar-light bg-light ph-nav border-bottom hidden-sm-down">
    <div class="container">
        <a class="ph-nav__logo" href="/">
            <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
            <br>
            <p>Péhápkaři</p>
        </a>

        <div id="top-menu-search" class="hidden-md-down">
            <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="pehapkari.cz" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Napiš co hledáš..." autocomplete="off"/>
</form>
        </div>

        <ul class="navbar-nav ml-auto hidden-sm-down" id="menu">
            <li>
                <a class="active" href="/blog">
                    Blog
                </a>
            </li>
            <li>
                <a class="" href="/prehaj-si-prednasku">
                    Videa
                </a>
            </li>
            <li class="pr-0">
                <a class="" href="/kontakt">
                    Kontakt
                </a>
            </li>
        </ul>
    </div>
</nav>

<div id="mobile-menu" class="row ml-0 mr-0 text-center hidden-md-up border-bottom">
    <a href="/" class="ph-nav__logo col-3 ">
        <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
    </a>

    <a href="/prehaj-si-prednasku" class="col-3 ">
        Videa
    </a>
    <a href="/blog" class="col-3 ">
        Blog
    </a>
</div>

                    <div id="main">
                

                    <div class="container" id="article">
        <h1>Domain-Driven Design, part 7 - Alternative Relational Database Mapping</h1>

        <strong>Svaťa Šimara</strong>
        &nbsp;
        <time datetime="2018-03-Wed">
            21. 3. 2018
        </time>

        <br>

        <div class="card mt-4 mb-4">
            <div class="card-body text-bigger">
                <p>Do you think that multilingual text must always be in a separate database table? Than this article is for you!</p>
<p>We will show that not all arrays have to be mapped as database tables.
And we will also show the Doctrine implementation.</p>
            </div>
        </div>

        <h2>Product Name Story</h2>
<p>We worked on an e-shop and the product had exactly one name.
One day we faced confronted with the reality - the e-shop has to be multilingual.
I imagined a new database table for every language field immediately, and I was disgusted by all the tables that had to be created.
But luckily I asked myself - <em>What is the domain?</em></p>
<h3>Use cases</h3>
<p>The domain can be extracted from stories and use cases.
We discussed this in our team and we extracted a couple of use cases:</p>
<ul>
<li>Change the product name in the language.</li>
<li>Show the product name in the language
<ul>
<li>If the name in language is missing, show an empty string</li>
</ul></li>
</ul>
<p>We don’t have a use case to remove a name.
The product could exist without a name anyway, so creating one wasn't a problem.</p>
<h2>LangValue Extraction</h2>
<p>Use cases were the same for all names or descriptions in the system that had to be multilingual.
So we decided to extract use cases and responsibility into a common LangValue.</p>
<p>LangeValue is a multilingual text, this is its responsibility.
It has to be able to change the text in the language and read the text in the language.
It doesn't have an identity - LangValue is identified by all its properties, it is a <a href="/blog/2018/01/06/domain-driven-design-simplify-object-model#value-objects">value object</a>.
We decided that language identifier can be any string.</p>
<pre><code class="language-php">class LangValue {

    /**
     * @var string[] [string =&gt; string]
     */
    private $strings = [];

    public function __construct(array $strings = []) {
        foreach ($strings as $lang =&gt; $string) {
            $this-&gt;strings[$lang] = (string) $string;
        }
    }

    public function cloneWith(string $lang, string $string): self {
        $all = $this-&gt;all();
        $all[$lang] = $string;
        return new self($all);
    }

    public function read(string $lang): string {
        return $this-&gt;strings[$lang] ?? '';
    }

    public function all(): array {
        return $this-&gt;strings;
    }
}</code></pre>
<p>The implementation of the multilingual product name is simple.
The class is simplified to be instructive.</p>
<pre><code class="language-php">class Product {
    /**
     * @var LangValue
     */
    private $name;

    public function __construct()
    {
        $this-&gt;name = new LangValue();
    }

    public function changeName(string $language, string $name): void {
        $this-&gt;name = $this-&gt;name-&gt;cloneWith($language, $name);
    }

    public function showName(string $language): string {
        return $this-&gt;name-&gt;read($language);
    }
}</code></pre>
<h2>Relational Database Storage</h2>
<p>The LangValue works great in objects but how to save it into a relational database?
Well, we could think that text in language must be in a separate table.
That would be difficult to map, even impossible without changing the domain model.</p>
<p>Let's take a step back.
What are our use cases? We have to be able to change the text in the language and read it in the given language.
This is what our class LangValue does by itself.</p>
<p>Do we have the use case that needs language text in a separated table?
I don't think so.
So what if the LangValue would be serialized in a single field?
Does it cause problems?
It could be difficult to find a product by name in the language, but we do not have such a use case.
So the serialization can be a good option.</p>
<blockquote>
<p><strong>Disclaimer</strong></p>
<p>In a real project we have the finding use case.
We have a dedicated database with a special structure for a quick search.</p>
</blockquote>
<h3>Serialization</h3>
<p>We decided to use LangValue serialization.</p>
<p>We can serialize it by PHP <code>serialize</code> function or extract the internal array and serialize it.
Both styles are similar - they end up with PHP structure encoded in a string that is not readable by people and by databases.</p>
<p>We can use custom serialization method, but that would probably be a horrible choice.</p>
<p>We can also serialize the LangValue into a JSON.
It is readable by people and some databases and can work with JSON data type too.
This seems to be a reasonable choice.</p>
<h2>LangValue Doctrine Mapping</h2>
<p>We need to convert the LangValue to the JSON and vice versa.</p>
<p>Doctrine supports custom mapping type for this particular task.
Once the custom type is registered and mapped, all objects are mapped correctly to the database.
The custom type is registered in DBAL layer, so even when we hydrate arrays instead of objects, text is hydrated as LangValue object.
When we hydrate scalars, we get raw data from the database - string JSONs.</p>
<p>If the target database supports JSON data type, the Doctrine works with it.
Otherwise, it uses the text data type.</p>
<pre><code class="language-php">use Doctrine\DBAL\Platforms\AbstractPlatform;
use Doctrine\DBAL\Types\Type;

class LangValueType extends Type {

    const LANG_VALUE = 'langValue';

    public function getName() {
        return self::LANG_VALUE;
    }

    public function getSQLDeclaration(array $fieldDeclaration, AbstractPlatform $platform) {
        return $platform-&gt;getJsonTypeDeclarationSQL($fieldDeclaration);
    }

    public function requiresSQLCommentHint(AbstractPlatform $platform) {
        return !$platform-&gt;hasNativeJsonType();
    }

    public function convertToDatabaseValue($value, AbstractPlatform $platform) {
        if ($value === NULL) {
            return NULL;
        }

        return json_encode($value-&gt;all(), JSON_UNESCAPED_UNICODE);
    }

    public function convertToPHPValue($value, AbstractPlatform $platform) {

        if ($value === NULL || $value === '') {
            return new LangValue;
        }

        $value = (is_resource($value)) ? stream_get_contents($value) : $value;

        return new LangValue(json_decode($value, TRUE));
    }
}</code></pre>
<h4>Registration</h4>
<p>We have to add code to the Doctrine integration.</p>
<pre><code class="language-php">\Doctrine\DBAL\Types\Type::addType(LangValueType::LANG_VALUE, LangValueType::class);

/** @var Doctrine\DBAL\Connection */
$connection = ...;
$platform = $connection-&gt;getDatabasePlatform();
$platform-&gt;registerDoctrineTypeMapping(LangValueType::LANG_VALUE, LangValueType::LANG_VALUE);</code></pre>
<h4>Mapping</h4>
<pre><code class="language-xml">&lt;doctrine-mapping&gt;
    &lt;entity name="Product"&gt;
        &lt;field name="name" type="langValue" /&gt;
    &lt;/entity&gt;
&lt;/doctrine-mapping&gt;</code></pre>
<h2>Database Search in JSON</h2>
<p>A relational database isn't usually a good choice for a full-text search.
But some databases allow us to query the JSON data type anyway.</p>
<p>If we want to search using JSON, we can always write a native query.
Or we can create a custom DQL function that is translated into engine-specific JSON query.</p>
<h3>PostgreSQL</h3>
<pre><code class="language-postgresql">SELECT * FROM Product where name-&gt;&gt;'cs' LIKE '%query%';</code></pre>
<h3>MySQL</h3>
<pre><code class="language-mysql">SELECT * FROM Product where name-&gt;'$.cs' LIKE '%query%';</code></pre>
<h2>TL;DR</h2>
<p>Think before mapping.
Even if you are experienced, you can find some new and creative mapping styles.
Focus on use cases, do the object model first and think about relations and mapping later.
JSON object serialization is useful.</p>
<h2>References</h2>
<p>DOCTRINE TEAM.
<em>Custom Mapping Types - Doctrine 2 ORM 2 documentation</em> [online].
2018 [2018-03-14].
Available: <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/cookbook/custom-mapping-types.html">http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/cookbook/custom-mapping-types.html</a></p>
<h2>Contact</h2>
<p>Are you designing architecture and like DDD approach? Hire me, I can help you - <a href="http://svatasimara.cz/">svatasimara.cz</a></p>

        <br>

        <div class="container">
            <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <br>
    </div>

            </div>
        
        <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <p class="mb-2">Web Péhápkaři.cz pohání <a href="https://symfony.com/">Symfony</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.</p>

                                            </div>

            <div class="col-12 col-md-6 mt-4 mt-md-0">
                <ul id="socials" class="pull-right">
                    <li>
                        <a href="https://facebook.com/pehapkari">
                            <em class="fab fa-2x fa-facebook"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://twitter.com/pehapkari">
                            <em class="fab fa-2x fa-twitter"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/friends-of-php-prague/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Praha</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/Pehapkari-Brno/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Brno</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://github.com/pehapkari">
                            <em class="fab fa-2x fa-github"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ">
                            <em class="fab fa-2x fa-slack"></em>
                        </a>
                        <p>
                            <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ/">
                                <span class="hidden-sm-down">Pozvi se</span>
                                <span class="hidden-md-up">Pozvi</span>
                            </a>
                        </p>
                    </li>
                </ul>
            </div>
        </div>

        <div id="footer_body">
            <div class="row">
                <div class="col-6 col-md-4 mb-4 mb-md-0">
                    <h3>O nás</h3>

                    <ul class="bottom_menu">
                        <li>
                            <a href="/kontakt">Kontakt</a>
                        </li>

                        <li>
                            <a href="/for-speakers">Pro speakry</a>
                        </li>

                        <li>
                            <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/public/assets/pehapkari_logo">Logo</a>
                        </li>

                        <li>
                            <a href="/rss.xml">RSS blogu</a>
                        </li>

                        <li>
                            <a href="http://bit.ly/pehapkari-newsletter">Sleduj Newsletter</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/build/js/app.js"></script>

<script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
<script>
    $('document').ready(function() {
        var typed = new Typed('#typed',{
            stringsElement: '#typed-strings',
            typeSpeed: 50,
            backDelay: 1400,
        });
    });
</script>

<script src="/assets/prism/prism.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
