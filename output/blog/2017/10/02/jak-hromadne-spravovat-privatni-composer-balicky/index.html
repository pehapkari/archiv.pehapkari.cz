<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Otevřené místo pro všechny PHP programátory">
<meta name="keywords" content="PHP, komunita, programování, srazy, školení, blog, články">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/assets/images/meetup.jpg">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap&subset=latin-ext" rel="stylesheet">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<link href="/favicon.ico" rel="shortcut icon">

<title>
     Jak hromadně spravovat privátní composer balíčky | Děláš v PHP? Jsi jedním z nás
</title>

<link rel="stylesheet" href="/build/css/app.css">

<link rel="stylesheet" href="/assets/prism/prism.css">
<link rel="stylesheet" href="/assets/prism/prism-custom.css">

<link rel="stylesheet" href="https://use.typekit.net/jmg2upk.css">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i|Ubuntu+Mono&amp;subset=latin-ext" rel="stylesheet">

        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    </head>

    <body id="">
        <nav id="ph-nav" class="navbar fixed-top navbar-expand navbar-light bg-light ph-nav border-bottom hidden-sm-down">
    <div class="container">
        <a class="ph-nav__logo" href="/">
            <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
            <br>
            <p>Péhápkaři</p>
        </a>

        <div id="top-menu-search" class="hidden-md-down">
            <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="pehapkari.cz" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Napiš co hledáš..." autocomplete="off"/>
</form>
        </div>

        <ul class="navbar-nav ml-auto hidden-sm-down" id="menu">
            <li>
                <a class="active" href="/blog">
                    Blog
                </a>
            </li>
            <li>
                <a class="" href="/prehaj-si-prednasku">
                    Videa
                </a>
            </li>
            <li class="pr-0">
                <a class="" href="/kontakt">
                    Kontakt
                </a>
            </li>
        </ul>
    </div>
</nav>

<div id="mobile-menu" class="row ml-0 mr-0 text-center hidden-md-up border-bottom">
    <a href="/" class="ph-nav__logo col-3 ">
        <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
    </a>

    <a href="/prehaj-si-prednasku" class="col-3 ">
        Videa
    </a>
    <a href="/blog" class="col-3 ">
        Blog
    </a>
</div>

                    <div id="main">
                

                    <div class="container" id="article">
        <h1>Jak hromadně spravovat privátní composer balíčky</h1>

        <strong>Martin Knor</strong>
        &nbsp;
        <time datetime="2017-10-Mon">
            2. 10. 2017
        </time>

        <br>

        <div class="card mt-4 mb-4">
            <div class="card-body text-bigger">
                <p>Composer je dobrý sluha, ale zlý pán, pokud nevíte jak s ním pracovat. Podívejte se na naše workflow vývoje, kdy je dána plně modulární aplikace a ta se řídí závislostmi na konkrétních balíčcích.</p>
            </div>
        </div>

        <p>Při vývoji člověk dojde do určité fáze, kdy je potřeba projekt nějakým způsobem rozšiřovat dál, nabídnout více klientům. Tady se pak dostáváme do situace, kdy má sice funkční aplikaci, ale naráží na různé problémy. Jedním z nich může být když chce klient nějakou modifikaci. Nebo se najde nějaká chyba. To vše vede k tomu že se musí upravovat kód u každého klienta zvlášť. Řešení je jednoduché. Rozdělit kód do balíčků a ty verzovat. Klientům lze pak poskytovat konkrétní verze.</p>
<h2>Podívejme se na to, jak to řešíme u nás</h2>
<p>Nejdříve je potřeba si rozdělit aplikaci na logické celky tak, aby to dávalo smysl. Mějme např. klienta „klient“ a ten bude mít závislosti v composer.json.</p>
<pre><code class="language-json">{
  "name": "clear01/klient",
  "require": {
    "clear01/comgate": "^v1.1",
    "clear01/pohoda": "^v1.1.6",
    "clear01/component": "^v1.0.0",
    "clear01/ecommerce": "^v1.3.14",
    "clear01/zasilkovna": "^v1.0.1",
    "clear01/html-meta": "^v1.0.2"
  }
}</code></pre>
<p>Každý jednotlivý balíček obsahuje svůj vlastní <code>composer.json</code> s případnými dalšími závislostmi. Jakmile máme balíček hotový, můžeme ho nahrát do svého privátního repozitáře (bitbucket, github). Další možností je využít nějakého <a href="https://getcomposer.org/doc/articles/handling-private-packages-with-satis.md">package managera</a> (<a href="https://packagist.com/">packagist</a> – placený pro privátní balíčky, <a href="https://github.com/composer/satis">satis</a> – open source pro vlastní hostování). Rozhodování je jednoduché. Pokud vám nevadí placená verze, je pohodlnější packagist. Satis je sice zdarma, ale musíte si ho nainstalovat sami a řešit zabezpečení apod.</p>
<p>Aby vám composer načítal privátní balíčky, je potřeba přidat repozitáře / managera do configu, aby o něm composer věděl. To provedete pomocí <code>composer config -e</code> (případně přidáte <code>-g</code> pro globální config).</p>
<h3>Přidání lokálního repozitáře</h3>
<p>Můžete přidat balíček z lokálního disku. Tady jen pozor, composer pak neumí pracovat s tagy, udělá to, že vytvoří symlink do vendoru, což je obzvláště výhodné při vývoji, protože není potřeba při každé změně volat <code>composer update</code>.</p>
<pre><code class="language-json">{
  "repositories": [
    { "type": "path", "url": "/var/www/clear01/ecommerce" }
  ]
}</code></pre>
<h3>Přidání privátního repozitáře</h3>
<p>Tady je potřeba mít nastavený správný přístup ke git (bitbucket,...) repozitářům, zejména autentizaci tak, aby si composer správně načetl balíčky z privátních repozitářů.</p>
<pre><code class="language-json">{
  "repositories": [
    {"type": "vcs", "url": "git@github.com:clear01/comgate.git" }
  ]
}</code></pre>
<h3>Přidání managera balíčků</h3>
<p>Lze přidat např. satis, což je obdoba packagist pro privátní balíčky. Ten dělá balíčky konkrétních verzí, příp. načítá automaticky nové z repozitářů a následně je servíruje klientům, což je výhodné, protože nemusíte pak na všechny klienty přidávat jednotlivé repozitáře. Jen přidáte managera a máte vystaráno.</p>
<pre><code class="language-json">{
  "repositories": [
    { "type": "composer", "url": "https://satis.example.com" }
  ]
}</code></pre>
<p>U vlastního managera je potřeba obvykle ještě nastavit příp. <a href="https://getcomposer.org/doc/articles/handling-private-packages-with-satis.md#authentication">autentizaci</a>, která je ale lepší řešit např. v <code>auth.json</code> (http-auth, apod.)</p>
<p>Pokud máme správně nastaveny přístupy k privátním balíčkům, musíme si ještě nastavit vývojové prostředí:</p>
<h2>PhpStorm</h2>
<p>Takto připravenou aplikaci jednoduše přidáme jako projekt v PhpStormu. Ten se nás v aktuální verzi zeptá, zda chceme nastavit vývojové prostředí z <code>composer.json</code>, což nám ulehčuje práci. Toto nastaví verzi php (pokud je v <code>composer.json</code>), cesty a příp. přidá vendor knihovny do external libraries.</p>
<p>Při zavolání <code>composer install</code> by se nám již měly nainstalovat správné verze našich balíčků. Takto máme připravenu aplikaci pro jednoho klienta. No jo, řeknete si, ale co když potřebuju upravit jeden balíček, který je závislý na druhém? Běžně by jste museli stáhnout a upravit každý balíček zvlášť, commitnout, přidat tag, pushnout a spustit composer update. To je docela zdlouhavé, pokud upravujete třeba 4 balíčky které jsou na sobě závislé.</p>
<h3>Jak na to chytře?</h3>
<p>Nejdříve si načtete aplikaci pomocí <code>composer install –-prefer-source</code>, což vám <strong>načte balíčky včetně git repozitářů</strong>, takže nad nimi můžete pracovat, přepínat větve, přidávat tagy atd. Pokud chcete upravovat jen konkrétní balíčky, <strong>je lepší zavolat <code>composer update namespace/package --prefer-source</code> nad konkrétním balíčkem</strong>, protože jinak se stahují všechny balíčky z composer včetně git meta dat a tato akce může nějakou dobu trvat, obzvláště pokud máte hodně závislostí.</p>
<p>Poté jednoduše přidáte v phpstormu repozitáře do jeho správy.</p>
<div class="text-center">
     <img src="/assets/images/posts/2017/composer/git.png">
 </div>
<p><br/></p>
<p>Tím se dostáváme k tomu <strong>největšímu usnadnění</strong>. Teď již můžeme dělat změny ve všech balíčcích v jednom projektu. Pro usnadnění je dobré ještě v nastavení phpstormu zaškrtnout volbu <strong>control repositories synchronously</strong>, která vám umožní pracovat s větvemi jako by to byla jedna. <strong>Tzn. pokud vytvoříte jednu větev test, vytvoří se ve všech repozitářích a udělá se checkout.</strong></p>
<div class="text-center">
      <img src="/assets/images/posts/2017/composer/synchro.png">
  </div>
<p><br/></p>
<p><strong>PhpStorm tedy umí pracovat s několika git repozitáři současně.</strong> Pro práci doporučuji vytvořit novou větev, což lze udělat jednoduše a phpstorm už se postará o zbytek. Dole na obrázku vidíte že se mi automaticky všechny repozitáře přeply do větve test. Commit a push probíha obdobně.</p>
<div class="text-center">
     <img src="/assets/images/posts/2017/composer/branch.png">
 </div>
<p><br/></p>
<p>Pak už jen stačí vytvořit tag a profit.</p>
<p><em>Tip na závěr:</em> pro hromadný update repozitářů z remote doporučuji plugin <strong><a href="https://plugins.jetbrains.com/plugin/7835-git-extender">git extender</a></strong></p>

        <br>

        <div class="container">
            <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <br>
    </div>

            </div>
        
        <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <p class="mb-2">Web Péhápkaři.cz pohání <a href="https://symfony.com/">Symfony</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.</p>

                                            </div>

            <div class="col-12 col-md-6 mt-4 mt-md-0">
                <ul id="socials" class="pull-right">
                    <li>
                        <a href="https://facebook.com/pehapkari">
                            <em class="fab fa-2x fa-facebook"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://twitter.com/pehapkari">
                            <em class="fab fa-2x fa-twitter"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/friends-of-php-prague/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Praha</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/Pehapkari-Brno/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Brno</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://github.com/pehapkari">
                            <em class="fab fa-2x fa-github"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ">
                            <em class="fab fa-2x fa-slack"></em>
                        </a>
                        <p>
                            <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ/">
                                <span class="hidden-sm-down">Pozvi se</span>
                                <span class="hidden-md-up">Pozvi</span>
                            </a>
                        </p>
                    </li>
                </ul>
            </div>
        </div>

        <div id="footer_body">
            <div class="row">
                <div class="col-6 col-md-4 mb-4 mb-md-0">
                    <h3>O nás</h3>

                    <ul class="bottom_menu">
                        <li>
                            <a href="/kontakt">Kontakt</a>
                        </li>

                        <li>
                            <a href="/for-speakers">Pro speakry</a>
                        </li>

                        <li>
                            <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/public/assets/pehapkari_logo">Logo</a>
                        </li>

                        <li>
                            <a href="/rss.xml">RSS blogu</a>
                        </li>

                        <li>
                            <a href="http://bit.ly/pehapkari-newsletter">Sleduj Newsletter</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/build/js/app.js"></script>

<script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
<script>
    $('document').ready(function() {
        var typed = new Typed('#typed',{
            stringsElement: '#typed-strings',
            typeSpeed: 50,
            backDelay: 1400,
        });
    });
</script>

<script src="/assets/prism/prism.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
