<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Otevřené místo pro všechny PHP programátory">
<meta name="keywords" content="PHP, komunita, programování, srazy, školení, blog, články">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/assets/images/meetup.jpg">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap&subset=latin-ext" rel="stylesheet">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<link href="/favicon.ico" rel="shortcut icon">

<title>
     How we Migrated 54 357-lines Application from Nette to Symfony in 2 People under 80 Hours | Děláš v PHP? Jsi jedním z nás
</title>

<link rel="stylesheet" href="/build/css/app.86e96c5c.css">

<link rel="stylesheet" href="/assets/prism/prism.css">
<link rel="stylesheet" href="/assets/prism/prism-custom.css">

<link rel="stylesheet" href="https://use.typekit.net/jmg2upk.css">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i|Ubuntu+Mono&amp;subset=latin-ext" rel="stylesheet">

        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    </head>

    <body id="">
        <nav id="ph-nav" class="navbar fixed-top navbar-expand navbar-light bg-light ph-nav border-bottom hidden-sm-down">
    <div class="container">
        <a class="ph-nav__logo" href="/">
            <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
            <br>
            <p>Péhápkaři</p>
        </a>

        <div id="top-menu-search" class="hidden-md-down">
            <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="pehapkari.cz" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Napiš co hledáš..." autocomplete="off"/>
</form>
        </div>

        <ul class="navbar-nav ml-auto hidden-sm-down" id="menu">
            <li>
                <a class="active" href="/blog">
                    Blog
                </a>
            </li>
            <li>
                <a class="" href="/prehaj-si-prednasku">
                    Videa
                </a>
            </li>
            <li class="pr-0">
                <a class="" href="/kontakt">
                    Kontakt
                </a>
            </li>
        </ul>
    </div>
</nav>

<div id="mobile-menu" class="row ml-0 mr-0 text-center hidden-md-up border-bottom">
    <a href="/" class="ph-nav__logo col-3 ">
        <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
    </a>

    <a href="/prehaj-si-prednasku" class="col-3 ">
        Videa
    </a>
    <a href="/blog" class="col-3 ">
        Blog
    </a>
</div>

                    <div id="main">
                

                    <div class="container" id="article">
        <h1>How we Migrated 54 357-lines Application from Nette to Symfony in 2 People under 80 Hours</h1>

        <strong>Tomáš Votruba</strong>
        &nbsp;
        <time datetime="2019-04-Sat">
            20. 4. 2019
        </time>

        <br>

        <div class="card mt-4 mb-4">
            <div class="card-body text-bigger">
                <p>It would take us 3 full-time months to rewrite this code in 2017. In February 2019 we did it in less than 3-week span with the help of automated tools. Why and how?</p>
            </div>
        </div>

        <p><em>This post was originally published <a href="https://www.zdrojak.cz/clanky/50k-radku-z-nette-do-symfony/">in Czech on Zdrojak.cz</a>, where it got huge attention of Czech PHP community and hit amazing 54 comments (a possible record). But when I talk about this migration with my English speaking PHP friends, it seems crazy to them and they want to hear details - who, how, when, what exactly?</em></p>
<p><em>This post is for you (and for you of course, if you haven't read it on Zdroják).</em></p>
<div class="text-center">
<img src="/assets/images/posts/2019/fw-migration/nette-to-symfony.png"></div>
<h2>What Have We Migrated?</h2>
<p>Backend of <a href="https://entry.do/">Entry.do</a> project - API application built on controllers, routing, Kdyby integrations of Symfony, Doctrine and a few Latte templates. The application has been running in production for last 4 years. We migrated from Nette 2.4 to Symfony&nbsp;4.2.</p>
<p>How big is it? If we don't count tests, migration, fixtures, etc., the application has <strong>270 PHP files</strong> in the length of <strong>54 357 lines</strong> (using <a href="https://github.com/sebastianbergmann/phploc">phploc</a>).</p>
<p>How many unique routes does it have? 20...? 50...? <strong>151!</strong>
Just to have an idea, the pehapkari.cz website has 35 routes.</p>
<h2>Why?</h2>
<p>The application was written in Nette, which worked and met the technical requirements. The main motivation for the transcription was the dying ecosystem and that over-integration of Symfony. What does &quot;dying ecosystem&quot; mean? Nette released just 1 minor version since July 2016, while Symfony had 6 releases during the same period.</p>
<div class="text-center mb-4">
    <img src="/assets/images/posts/2019/fw-migration/extensions.png"><br><em>80% of the extensions are just glue integrations of Symfony and Doctrine</em>
</div>
<div class="text-center mb-4">
    <img src="/assets/images/posts/2019/fw-migration/nette-symfony.png"><br><em>Nette was just Controllers, Routing and Dependency-Injection</em>
</div>
<p>Why use unmaintained integrations of <a href="https://github.com/kdyby">Kdyby</a> and <a href="https://github.com/zenify">Zenify</a>, that only integrate Symfony to Nette\DI, if Symfony is already there? Last new minor version of Nette was published 3 years ago. Symfony releases new minor version every 6 months with new features will make your work easier.</p>
<h2>How?</h2>
<p>I offered <a href="http://github.com/JanMikes">Honza Mikeš</a> deal he couldn't refuse:</p>
<blockquote class="blockquote text-center">
"We will give it a week and if we stuck, we'll give up".
</blockquote>
<p>On the January 27th, we met with his Nette application and on February 13th the Symfony application went to the staging server. <strong>In less than 17 days we were done</strong> and on February 14th we celebrated a new production application in addition to Valentine's Day.</p>
<div class="text-center">
<img src="/assets/images/posts/2019/fw-migration/pull-request.png">
<p><em>The final size of migration pull-request</em></p>
</div>
<p>In fact, we were talking about migration at the beginning of 2017, because the Nette ecosystem wasn't really developing and Symfony was technologically skipping it. At that time, however, the transition would last at least 80-90 days for full-time, which is insane, so we didn't go into it.</p>
<h2>Tool Set</h2>
<p>In 2019 we already have a <strong>lot of tools to do the work for you</strong>:</p>
<ul>
<li>
<p>The first is <a href="https://github.com/rectorphp/rector">Rector</a>, tool I made that can change any code that runs at least on PHP 5.3 from pattern A to pattern B. It can instantly update the code from PHP 5.3, 5.4, 5.5, 5.6... to 7.4, Symfony from 2.8 to 4.2, Laravel from static code to constructor injection, and more. You can add your own rules tailored to migrate your specific code, that can handle anything that PHP programmer can do (A → B) in a fraction of the time.</p>
</li>
<li>
<p>The second is <a href="https://github.com/Symplify/NeonToYamlConverter">NeonToYamlConverter</a> - as you can guess, it converts NEON syntax to YAML</p>
</li>
<li>
<p>The third assistant is <a href="https://github.com/symplify/lattetotwigconverter">LatteToTwigConverter</a> - it migrates Latte files to TWIG syntax</p>
</li>
</ul>
<p>During those <strong>17 days we put in 80 hours of work</strong> for both of us together (= 40 hours each).</p>
<h2>20 % of Good Old Manual Work</h2>
<p>Although we do not like it, we had to do 20 % of the migration manually.</p>
<p>One of the first steps was to move from <a href="https://www.tomasvotruba.cz/blog/2019/02/14/why-config-coding-sucks/">config programming to PHP programming</a>. Both frameworks try to promote their own sugar syntax for Neon or YAML. It sounds cool to new programmers, to write less code, but it's confusing, framework-specific, can be done in clear PHP anyway, and most importantly, static analysis and instant refactoring won't deal with it.</p>
<p>How does &quot;config programming&quot; look like?</p>
<pre><code class="language-yaml">services:
    - FirstService(@secondService::someMethod())</code></pre>
<p>Or also:</p>
<pre><code class="language-yaml">services:
    -
        class: 'Entrydo\Infrastructure\Payment\GoPay\NotifyUrlFactory'
        arguments:
            - '@http.request::getUrl()::getHostUrl()'</code></pre>
<p>What common PHP pattern, that is framework-agnostic and almost everyone knows, can we use?</p>
<p>Factory!</p>
<pre><code class="language-php">&lt;?php

final class FirstServiceFactory
{
    /**
     * @var SecondService
     */
    private $secondService;

    public function __construct(SecondService $secondService)
    {
        $this-&gt;secondService = $secondService;
    }

    public function create()
    {
        return new SomeService($this-&gt;secondService);
    }
}</code></pre>
<h3>What did we Gained with This Refactoring?</h3>
<ul>
<li>Constructor injection!</li>
<li>Framework independence - when we migrate to another framework or pattern in 3 years, we don't have to deal with this file anymore.</li>
<li>Static analysis works</li>
<li>More testable code, thanks to PHP code instead of config</li>
<li>PHPStorm refactoring works</li>
<li>Rector works</li>
<li>It's a clear PHP code</li>
</ul>
<p><br></p>
<p>In Nette and Symfony, several things were different:</p>
<ul>
<li>ErrorPresenter → <a href="https://symfony.com/doc/current/event_dispatcher.html%23creating-an-event-subscriber">ExceptionSubscriber</a></li>
<li>Use <a href="https://symfony.com/doc/current/testing.html">SymfonyTestBundle</a> for tests</li>
<li>Moving Files to <a href="http://fabien.potencier.org/symfony4-directory-structure.html">Symfony 4 Single-Level Structure</a></li>
<li>Exchange of services in mock tests</li>
<li>In Nette, there is a Request/Response service, but in Symfony, it's an object</li>
<li>Rewrite extension configs to Flex configs</li>
</ul>
<h2>80 % of Work Automated</h2>
<p>Another 80% of the pull-request you saw above was done by automatic tools. The first one was enough to write, the other one to set it up.</p>
<h3>Neon to YAML</h3>
<p>Neon and YAML are de facto fields <a href="https://www.tomasvotruba.cz/blog/2018/03/12/neon-vs-yaml-and-how-to-migrate-between-them/">with minor differences in syntax</a>, but when it comes to services, each framework writes a little differently. Config with services had 316 lines in the services section. You don't want to migrate it manually, the Neon entities. In addition, just one error in related migration and you can do it all over again.</p>
<p>I took few hours and wrote <a href="https://github.com/Symplify/NeonToYamlConverter">Symplify/NeonToYamlConverter</a>. Just pass the path to the <code>*.neon</code> file and it will convert into beautiful <code>*.yaml</code> file.</p>
<h3>PHP Migration</h3>
<p>Again to the factory pattern - there were several custom Response classes in the code that inherited from Nette Response and added extra logic. We could edit them manually one by one, but it was easier to extract them into the factory method:</p>
<pre><code class="language-diff"> &lt;?php

 class SomePresenter
 {
+    /**
+     * @var ResponseFactory
+     */
+    private $responseFactory;
+
+    public function __construct(ResponseFactory $responseFactory)
+    {
+        $this-&gt;responseFactory = $responseFactory;
+    }
+
     public function someAction()
     {
-        return new OKResponse($response);
+        return $this-&gt;responseFactory-&gt;createJsonResponse($response);
     }
 }</code></pre>
<p>Honza created new <code>NewObjectToFactoryCreateRector</code> rule that handled this.</p>
<h3>What else was left?</h3>
<ul>
<li>Move the routing from <code>RouterFactory</code> to particular Controller actions</li>
<li>Rename <code>Request</code> and <code>Response</code> classes + including their codes (<code>POST</code>, <code>GET</code>, <code>200</code>...)</li>
<li>Rename classes and methods on <code>Nette\DI\Container</code>, <code>Nette\Configurator</code>, <code>Nette\Application\IPresenter</code> etc,</li>
<li>Changing parent classes on Controllers,</li>
<li>Renaming Controllers to <code>*Controller</code> (they use &quot;Presenter&quot; naming in Nette)</li>
<li>Move namespaces from <code>App\Presenter</code> to <code>App\Controller</code></li>
</ul>
<p>The most changes were in controllers:</p>
<pre><code class="language-diff"> &lt;?php declare (strict_types = 1);
 
-namespace App\Presenter;
+namespace App\Controller;
 
-use Nette\Application\AI\Presenter;
+use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
-use Nette\Http\Request;
+use Symfony\Component\HttpFoundation\Request;

-final class SomePresenter extends Presenter
+final class SomeController extends AbstractController
 {
-    public static function someAction()
+    public static function someAction(Request $request)
     {
-        $header = $this-&gt; httpRequest-&gt; getHeader('x');
+        $header = $request-&gt; headers-&gt; get('x');

-        $method = Request::POST;
+        $method = Request::METHOD_HPOST
     }
 }</code></pre>
<h2>Syntax Sugar? Syntax Hell</h2>
<p>For a while, Kdyby\Translation screwed us with &quot;syntax sugar&quot;. In the Nette application, the listing of variables (Tom) worked for us:</p>
<ul>
<li>&quot;Hi, my name is Tom&quot;</li>
</ul>
<p>But in Symfony magically added <code>%%</code>:</p>
<ul>
<li>&quot;Hi, my name is% Tom%&quot;</li>
</ul>
<p>WTF? After 15 minutes we figured it out - Kdyby\Translation wrapped the variable name in &quot;%%&quot; for you - and fixed it:</p>
<pre><code class="language-diff"> &lt;?php

 class SomePresenter
 {
     public function someAction()
     {
         // Kdyby/Translation differnce to native Symfony/Translation
         $this-&gt;translations-&gt;translate('Hi, my name is %name%', [
-            'name' =&gt; 'Tom',
+            '%name%' =&gt; 'Tom'
         ]);
     }
 }</code></pre>
<p>Pretty cool, huh?</p>
<h2>Rename Event Names</h2>
<p>We also cannot forget the rename of events from Contribute\Events to Symfony <a href="https://symfony.com/doc/current/reference/events.html%23kernel-events">KernelEvents</a>:</p>
<div class="text-center">
    <img src="/assets/images/posts/2019/fw-migration/event-rename.png"></div>
<h2>From <code>RouterFactory</code> to Controller <code>@Route</code> annotation</h2>
<p>RouteFactory is <a href="https://github.com/nette/sandbox/blob/06a92123fb6a1d82de38037436ca06484afec8dc/app/Router/RouterFactory.php">single class</a> in Nette to define all routes for all controllers and their actions. In Symfony, this is quite the opposite. You define the routes directly at the Controller action. And to make matters worse it <a href="https://symfony.com/doc/current/routing.html%23creating-routes">uses annotation</a>.</p>
<p>What with this? Well, one option is to move one route at a time - <strong>all 151</strong>. To make it even more challenging, we had our own <code>RestRoute</code> and our own <code>RouteList</code>, including POST/GET/..., which Nette doesn't have.</p>
<p>How does one change look like?</p>
<pre><code class="language-diff"> &lt;?php

 namespace App;
 
 use Entrydo\RestRouteList;
 use Entrydo\Restart;

 final class RouterFactory
 {
-    private const PAYMENT_RESPONSE_ROUTE = '/ payment / process';
     // 150 more!
     
     public function create()
     {
         $router = new RestRouteList();
-        $router[] = RestRoute::get(self::PAYMENT_RESPONSE_ROUTE, ProcessGPWebPayResponsePresenter::class);
          // 150 more!
          
          return $router;
      }
 }</code></pre>
<pre><code class="language-diff"> namespace App Presenter;
  
+use Symfony\Component\Routing\Annotation\Route;
  
 final class ProcessGPWebPayResponsePresenter
 {
+    /**
+     * @Route(path = "/payments/gpwebpay/process-response", methods="GET"})
+     */
     public function __invoke()
     {
         // ...
     }
 }</code></pre>
<p>Now do this 151 times... and make rebase-proof. When we first talked about the migration in 2017, we would make all these changes manually. <strong>Too lazy to work.</strong></p>
<p>And in 2019? For a few days, we were preparing the <code>nette-to-symfony</code> Rector set and then run it on the entire code base:</p>
<pre><code class="language-bash">composer require rector/rector -dev
vendor/bin/rector process app src --level nette-to-symfony</code></pre>
<p>And it is done  :)</p>
<p>Everything we've learned during the 17-day migration is in this set and this post. Just download Rector and you can use the set straight away.</p>
<p>From Valentine's Day to the nette-to-symfony set, a complete migration from Nette Tester to PHPUnit and the migration of Nette Forms to Symfony Forms and Component to Controllers have been added.</p>
<h2>Final Touches</h2>
<p>After a lot of static content changes, the code worked and the tests went through, but it looked a bit messy. Spaces were missing, fully qualified class names were not imported, etc.</p>
<p>You can use your own PHP_CodeSniffer and PHP-CS-Fixer set. We used the <a href="https://github.com/rectorphp/rector/blob/master/ecs-after-rector.yaml">Rector-prepared set of 7 rules</a> with <a href="https://github.com/symplify/easyCodingStandard/">EasyCodingStandard</a>:</p>
<pre><code class="language-bash">vendor/bin/ecs check app src --config vendor/rector/rector/ecs-after-rector.yaml</code></pre>
<h2>It's not about the Work, It's about the Knowledge</h2>
<p>And so we migrated a 4-years old Nette application of 54 357 lines under 80 hours to Symfony and put it into production. The most of the time took us debugging of events and writing migration rules and tools. Now <strong>the same application would take us (or you) 10 hours top to migrate</strong>.</p>
<p><br></p>
<p>As you can see, any application can be migrate from one framework to another under a month. Dare us!</p>

        <br>

        <div class="container">
            <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <br>
    </div>

            </div>
        
        <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <p class="mb-2">Web Péhápkaři.cz pohání <a href="https://symfony.com/">Symfony</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.</p>

                                            </div>

            <div class="col-12 col-md-6 mt-4 mt-md-0">
                <ul id="socials" class="pull-right">
                    <li>
                        <a href="https://facebook.com/pehapkari">
                            <em class="fab fa-2x fa-facebook"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://twitter.com/pehapkari">
                            <em class="fab fa-2x fa-twitter"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/friends-of-php-prague/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Praha</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/Pehapkari-Brno/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Brno</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://github.com/pehapkari">
                            <em class="fab fa-2x fa-github"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ">
                            <em class="fab fa-2x fa-slack"></em>
                        </a>
                        <p>
                            <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ/">
                                <span class="hidden-sm-down">Pozvi se</span>
                                <span class="hidden-md-up">Pozvi</span>
                            </a>
                        </p>
                    </li>
                </ul>
            </div>
        </div>

        <div id="footer_body">
            <div class="row">
                <div class="col-6 col-md-4 mb-4 mb-md-0">
                    <h3>O nás</h3>

                    <ul class="bottom_menu">
                        <li>
                            <a href="/kontakt">Kontakt</a>
                        </li>

                        <li>
                            <a href="/for-speakers">Pro speakry</a>
                        </li>

                        <li>
                            <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/public/assets/pehapkari_logo">Logo</a>
                        </li>

                        <li>
                            <a href="/rss.xml">RSS blogu</a>
                        </li>

                        <li>
                            <a href="http://bit.ly/pehapkari-newsletter">Sleduj Newsletter</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/build/js/app.78e31948.js"></script>

<script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
<script>
    $('document').ready(function() {
        var typed = new Typed('#typed',{
            stringsElement: '#typed-strings',
            typeSpeed: 50,
            backDelay: 1400,
        });
    });
</script>

<script src="/assets/prism/prism.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
