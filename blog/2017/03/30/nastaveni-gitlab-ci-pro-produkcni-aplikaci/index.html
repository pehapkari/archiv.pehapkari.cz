<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Otevřené místo pro všechny PHP programátory">
<meta name="keywords" content="PHP, komunita, programování, srazy, školení, blog, články">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/assets/images/meetup.jpg">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap&subset=latin-ext" rel="stylesheet">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<link href="/favicon.ico" rel="shortcut icon">

<title>
     Nastavení GitLab CI pro produkční aplikaci | Děláš v PHP? Jsi jedním z nás
</title>

<link rel="stylesheet" href="/build/css/app.86e96c5c.css">

<link rel="stylesheet" href="/assets/prism/prism.css">
<link rel="stylesheet" href="/assets/prism/prism-custom.css">

<link rel="stylesheet" href="https://use.typekit.net/jmg2upk.css">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i|Ubuntu+Mono&amp;subset=latin-ext" rel="stylesheet">

        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    </head>

    <body id="">
        <nav id="ph-nav" class="navbar fixed-top navbar-expand navbar-light bg-light ph-nav border-bottom hidden-sm-down">
    <div class="container">
        <a class="ph-nav__logo" href="/">
            <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
            <br>
            <p>Péhápkaři</p>
        </a>

        <div id="top-menu-search" class="hidden-md-down">
            <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="pehapkari.cz" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Napiš co hledáš..." autocomplete="off"/>
</form>
        </div>

        <ul class="navbar-nav ml-auto hidden-sm-down" id="menu">
            <li>
                <a class="active" href="/blog">
                    Blog
                </a>
            </li>
            <li>
                <a class="" href="/prehaj-si-prednasku">
                    Videa
                </a>
            </li>
            <li class="pr-0">
                <a class="" href="/kontakt">
                    Kontakt
                </a>
            </li>
        </ul>
    </div>
</nav>

<div id="mobile-menu" class="row ml-0 mr-0 text-center hidden-md-up border-bottom">
    <a href="/" class="ph-nav__logo col-3 ">
        <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
    </a>

    <a href="/prehaj-si-prednasku" class="col-3 ">
        Videa
    </a>
    <a href="/blog" class="col-3 ">
        Blog
    </a>
</div>

                    <div id="main">
                

                    <div class="container" id="article">
        <h1>Nastavení GitLab CI pro produkční aplikaci</h1>

        <strong>Tomáš Jacík</strong>
        &nbsp;
        <time datetime="2017-03-Thu">
            30. 3. 2017
        </time>

        <br>

        <div class="card mt-4 mb-4">
            <div class="card-body text-bigger">
                <p>GitLab CI je dnes moderní. Vychází o něm články s krásnými, jednoduchými příklady, jak jej začít používat. Pak ale člověk narazí. Jak se utkat s překážkami a vyjít z toho jako vítěz?</p>
            </div>
        </div>

        <p>Už delší dobu jsem uvažoval, že vyzkouším GitLab a jeho <a href="https://cs.wikipedia.org/wiki/Pr%C5%AFb%C4%9B%C5%BEn%C3%A1_integrace">CI</a>
jako alternativu k Bitbucketu. Prozatím jsem jako CI používal <a href="https://www.phptesting.org/">PHPCI</a>, který sice nebyl špatný,
ale spokojený jsem s ním zrovna také nebyl. Nakonec mě přesvědčil až <a href="https://www.zdrojak.cz/clanky/gitlab-jako-continuous-integration-nejen-pro-php/">článek Martina Hujera na Zdrojáku</a>,
který nastavení popisoval velice jednoduše. Tak jednoduché jsem to bohužel neměl. Nakonec jsem se tím ale prokousal a zde je výsledek.
Před pokračováním doporučuji si článek přečíst, můj článek na něj reaguje.</p>
<h2>Jen pro pořádek</h2>
<ul>
<li>Používám hostovanou verzi GitLabu. Rozcházet jej u sebe se mi zatím nechtělo a vzhledem k &quot;ceně&quot; to pro mě asi ani nemá smysl.</li>
<li>Používání skriptů v Composeru mi příliš nevyhovuje. Při testování na CI používám jiný sled příkazů než na lokále.</li>
<li>Pro GitLab jsem použil vlastní Runner. Některé věci tedy mohou platit pouze pro tento use-case.</li>
</ul>
<h2>Dodatečná PHP rozšíření</h2>
<p>V odkazovaném článku je zmíněn Docker image <code>geertw/docker-php-ci</code>. Většina lidí asi sáhne buď po něm, nebo po čistém PHP image.
Po chvíli jsem ale zjistil, že mi v něm spousta rozšíření chybí. Musel jsem tedy řešit jak je doinstalovat. Originální image
kompiluje PHP ze zdrojáků a tak když chci rozšíření doinstalovat, musím ty standardní instalovat přes <code>docker-php-ext-install</code>
a ty nestandardní přes <code>pecl install</code>. Některé je navíc potřeba nastavit přes <code>docker-php-ext-configure</code> a abych nezapomněl,
musím mít nainstalovány potřebné dev knihovny. Občas byl oříšek přijít na to, co dané rozšíření chce. Co je horší, samotný
update APT a instalace rozšíření trvá zbytečně dlouho.</p>
<p>Nakonec jsem se tedy rozhodl udělat si image vlastní. Vyšel jsem z <a href="https://github.com/phusion/baseimage-docker">phusion/baseimage-docker</a>
a vyházel z něj vše co nebylo nutné (je koncipován spíše na produkci). PHP jsem do něj nainstaloval z mého oblíbeného
<a href="https://launchpad.net/~ondrej/+archive/ubuntu/php">PPA od Ondřeje Surého</a>. Jaké to má výhody?</p>
<ul>
<li>Balíčky se nainstalují jen jednou, při buildu image a samotný běh testů na CI je pak velmi rychlý.</li>
<li>Jsem zvyklý více na Ubuntu než Debian a baseimage-docker vychází z Ubuntu.</li>
<li>PPA od Ondřeje Surého obsahuje všechny rozšíření, na které si jen vzpomenu. Nemusím tedy řešit závislosti rošíření a nechat je kompilovat, vše si nainstaluje APT.</li>
<li>Rozšíření v image instaluji jednotným zůsobem, nemusím řešit co je z PECLu a co ne.</li>
<li>Mohu si v něm rovnou přes Composer globálně nainstalovat balíčky jako <a href="https://github.com/hirak/prestissimo">hirak/prestissimo</a> a zrychlit tím instalaci závislostí. Do konfigurace <code>cache</code> v <code>.gitlab-ci.yml</code> lze totiž zapsat jen věci uvnitř build složky, tedy ne <code>~/.composer</code></li>
<li>Buildy image lze na Docker Hubu zautomatizovat. Buildí se rovnou z Githubu, např. když vyjde nová verze PHP, a více se o ně nestarám.</li>
<li>Hodně se tím vyčistí konfigurace CI.</li>
</ul>
<p>Výsledek si můžete vyzkoušet použitím image <a href="https://hub.docker.com/r/sunfoxcz/php-build/">sunfoxcz/php-build</a>.</p>
<h2>Spouštění na různých verzích PHP</h2>
<p>Věcí, které se stahovaly, instalovaly a spouštěly, bylo hodně. Build pak běžel zbytečně dlouho. Chvíli mi trvalo přijít na to, jak to správně sestavit.</p>
<ul>
<li>Je potřeba nedefinovat si <code>stages</code>, aby CI vědělo, jak má po sobě joby pouštět. Jinak je bude pouštět klidně paralelně. Jindy zase paralelní spouštění chceme.</li>
<li>U jobů, které mají pouze připravit nějaká data dalším jobům, je pak potřeba nastavit <code>artifacts</code>, aby data byla zachována.</li>
<li><del>Artefaktům je zase potřeba nastavit <code>expire_in</code>, aby se neuchovávaly věčně.</del> (v <a href="https://about.gitlab.com/2017/03/22/gitlab-9-0-released/">GitLab &gt; 9.0 automaticky</a>)</li>
<li>I tak je to hodně řádků. Hodilo by se to něčím zjednodušit. Jen náhodou jsem narazil na <a href="https://docs.gitlab.com/ce/ci/yaml/#special-yaml-features">šablony</a>, když jsem hledal v dokumentaci něco úplně jiného :-)</li>
<li>Každý job by měl mít definován nějaký image, jinak používá image defaultní, definovaný na CI runneru. Lze ovšem definovat i globálně pro všechny joby v rootu konfigurace.</li>
</ul>
<p>Takto vypadá výsledek:</p>
<pre><code class="language-yaml">stages:
    - download
    - test

download:
    stage: download
    image: sunfoxcz/php-build:5.6
    script:
        - composer create-project --no-interaction --no-progress --prefer-dist jakub-onderka/php-parallel-lint temp/php-parallel-lint ~0.9
        - composer create-project --no-interaction --no-progress --prefer-dist nette/code-checker temp/code-checker ~2.5.0
    artifacts:
        paths:
            - temp/php-parallel-lint
            - temp/code-checker
        expire_in: 1 hour

.test_template: &amp;test_template
    stage: test
    services:
        - mongo:latest
        - mysql:latest
    before_script:
        - composer install --no-interaction --no-progress --no-suggest --optimize-autoloader
        - cp app/Config/config.test.neon app/Config/config.local.neon
        - "mysql -h mysql $MYSQL_DATABASE -p$MYSQL_ROOT_PASSWORD &lt; sql/000_structure.sql"
        - "mysql -h mysql $MYSQL_DATABASE -p$MYSQL_ROOT_PASSWORD &lt; tests/data/testdata.sql"
        - vendor/bin/phinx migrate -e production
    script:
        - php temp/php-parallel-lint/parallel-lint.php -e php,phpt -j $(nproc) app tests
        - php temp/code-checker/src/code-checker.php --short-arrays -d app
        - php temp/code-checker/src/code-checker.php --short-arrays -d tests
        - vendor/bin/tester -s -p php -c tests/php.ini tests

test:5.6:
    image: sunfoxcz/php-build:5.6
    &lt;&lt;: *test_template

test:7.0:
    image: sunfoxcz/php-build:7.0
    &lt;&lt;: *test_template

test:7.1:
    image: sunfoxcz/php-build:7.1
    &lt;&lt;: *test_template

test:7.2:
    image: sunfoxcz/php-build:7.2
    &lt;&lt;: *test_template</code></pre>
<h2>Další služby</h2>
<p>Když přidám <code>services</code>, jejich hostname je vždy jejich jméno. Tohle mi chvíli trvalo dohledat. Co mě dost překvapilo,
že služby nejde mezi joby sdílet. Ani když jejich definici dám globálně. Nechal jsem je proto jen v šabloně pro testy,
aby ostatní joby zbytečně nespouštěly jejich instance. Přitom by to bylo super, udělat si job, který nakrmí databázi a
ostatním jobům tak ušetří spoustu práce. Dokonce je na to založená issue, ale implementace zatím bohužel není.</p>
<h2>Volání externích zdrojů</h2>
<p>Po skončení buildu jsem chtěl poslat notifikaci na Slack. Moje staré CI na to mělo přímo plugin. Tady jsem musel opět
hledat. Nakonec jsem našel, že se notifikace do Slacku dají nastavit ve webovém rozhraní GitLabu, a to pro více věcí než
jen build, tak jsem to nastavil tam a neřešil, jak to nastavit v konfiguraci buildu.</p>
<p>Po úspěšném buildu jsem ale chtěl také zavolat <a href="https://github.com/REBELinBLUE/deployer">Deployer</a>, přes který aktuálně
nasazuji na server. Tam už jsem to nakonec řešit musel. Po nějakém tom zkoumání vypadal výsledek takto:</p>
<pre><code class="language-yaml">stages:
    - download
    - test
    - deploy

deploy to production:
    stage: deploy
    environment: production
    image: sunfoxcz/php-build:5.6
    script:
        - curl -s -X POST https://deployer.domain.tld/deploy/$DEPLOYER_WEBHOOK_KEY
    only:
        - master@skupina/repozitar</code></pre>
<ul>
<li>Přidal jsem další položku do <code>stages</code>, aby se deploy spouštěl až na konec.</li>
<li>Při prvním nasazení se <code>environment</code> objeví v rozhraní GitLabu. Poté je tam vidět, co je nasazeno. Snadno se pak přidá např. staging prostředí.</li>
<li>Nasazovat do produkce chci jen z masteru. Je také dobré napsat do <code>only</code> celý název repozitáře, aby se job nespouštěl i ve forku.</li>
<li>Super je, že k nasazení nedojde, ať už skončí špatně testy v jakékoliv verzi PHP.</li>
<li>Ve webovém rozhraní se dají nastavit tzv. &quot;Secret Variables&quot;, aby se nemusely api klíče a hesla psát přímo do configu. Příkladem je proměnná <code>$DEPLOYER_WEBHOOK_KEY</code>.</li>
<li>Pokud se necítíte na úplně automatické nasazení, použijte <code>when: manual</code>. Tato volba <a href="https://docs.gitlab.com/ce/ci/yaml/#when">přidá do GitLabu tlačítko</a>, kterým nasadíte.</li>
</ul>
<h2>Vlastní runner</h2>
<p>I když se mi podařilo čas buildu stáhnout na slušnou úroveň, na free instancích GitLabu mi to stále přišlo dost dlouho.
Cvičně jsem si tedy na <a href="https://www.digitalocean.com/">Digital Ocean</a> vytvořil z šablony 2GB VPS s Dockerem. Instalace
runneru je pak na pár minut. Rozdíl v rychlosti je velký a jede to skvěle i při 4 konkurenčních buildech.
Za ty prachy to rozhodně stojí.</p>
<p>Pro ukázku uvedu ještě kompletní <code>.gitlab-ci.yml</code>:</p>
<pre><code class="language-yaml">variables:
    GIT_DEPTH: "1"
    # Configure mysql environment variables (https://hub.docker.com/r/_/mysql/)
    MYSQL_DATABASE: test_db
    MYSQL_ROOT_PASSWORD: xxx

stages:
    - download
    - test
    - deploy

download:
    stage: download
    image: sunfoxcz/php-build:5.6
    script:
        - composer create-project --no-interaction --no-progress --prefer-dist jakub-onderka/php-parallel-lint temp/php-parallel-lint ~0.9
        - composer create-project --no-interaction --no-progress --prefer-dist nette/code-checker temp/code-checker ~2.5.0
    artifacts:
        paths:
            - temp/php-parallel-lint
            - temp/code-checker
        expire_in: 1 hour

.test_template: &amp;test_template
    stage: test
    services:
        - mongo:latest
        - mysql:latest
    before_script:
        - composer install --no-interaction --no-progress --no-suggest --optimize-autoloader
        - cp app/Config/config.test.neon app/Config/config.local.neon
        - "mysql -h mysql $MYSQL_DATABASE -p$MYSQL_ROOT_PASSWORD &lt; sql/000_structure.sql"
        - "mysql -h mysql $MYSQL_DATABASE -p$MYSQL_ROOT_PASSWORD &lt; tests/data/testdata.sql"
        - vendor/bin/phinx migrate -e production
    script:
        - php temp/php-parallel-lint/parallel-lint.php -e php,phpt -j $(nproc) app tests
        - php temp/code-checker/src/code-checker.php --short-arrays -d app
        - php temp/code-checker/src/code-checker.php --short-arrays -d tests
        - vendor/bin/tester -s -p php -c tests/php.ini tests

test:5.6:
    image: sunfoxcz/php-build:5.6
    &lt;&lt;: *test_template

test:7.0:
    image: sunfoxcz/php-build:7.0
    &lt;&lt;: *test_template

test:7.1:
    image: sunfoxcz/php-build:7.1
    &lt;&lt;: *test_template

deploy to production:
    stage: deploy
    environment: production
    image: sunfoxcz/php-build:5.6
    script:
        - curl -s -X POST https://deployer.domain.tld/deploy/$DEPLOYER_WEBHOOK_KEY
    only:
        - master

cache:
    paths:
        - vendor</code></pre>

        <br>

        <div class="container">
            <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <br>
    </div>

            </div>
        
        <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <p class="mb-2">Web Péhápkaři.cz pohání <a href="https://symfony.com/">Symfony</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.</p>

                                            </div>

            <div class="col-12 col-md-6 mt-4 mt-md-0">
                <ul id="socials" class="pull-right">
                    <li>
                        <a href="https://facebook.com/pehapkari">
                            <em class="fab fa-2x fa-facebook"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://twitter.com/pehapkari">
                            <em class="fab fa-2x fa-twitter"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/friends-of-php-prague/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Praha</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/Pehapkari-Brno/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Brno</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://github.com/pehapkari">
                            <em class="fab fa-2x fa-github"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ">
                            <em class="fab fa-2x fa-slack"></em>
                        </a>
                        <p>
                            <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ/">
                                <span class="hidden-sm-down">Pozvi se</span>
                                <span class="hidden-md-up">Pozvi</span>
                            </a>
                        </p>
                    </li>
                </ul>
            </div>
        </div>

        <div id="footer_body">
            <div class="row">
                <div class="col-6 col-md-4 mb-4 mb-md-0">
                    <h3>O nás</h3>

                    <ul class="bottom_menu">
                        <li>
                            <a href="/kontakt">Kontakt</a>
                        </li>

                        <li>
                            <a href="/for-speakers">Pro speakry</a>
                        </li>

                        <li>
                            <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/public/assets/pehapkari_logo">Logo</a>
                        </li>

                        <li>
                            <a href="/rss.xml">RSS blogu</a>
                        </li>

                        <li>
                            <a href="http://bit.ly/pehapkari-newsletter">Sleduj Newsletter</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/build/js/app.78e31948.js"></script>

<script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
<script>
    $('document').ready(function() {
        var typed = new Typed('#typed',{
            stringsElement: '#typed-strings',
            typeSpeed: 50,
            backDelay: 1400,
        });
    });
</script>

<script src="/assets/prism/prism.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
