<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<meta name="description" content="Otevřené místo pro všechny PHP programátory">
<meta name="keywords" content="PHP, komunita, programování, srazy, školení, blog, články">
<meta name="author" content="https://pehapkari.cz">
<meta name="robots" content="index, follow">

<meta property="og:image" content="/assets/images/meetup.jpg">
<meta property="fb:pages" content="918297778220033" />

<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<link rel="alternate" type="application/rss+xml" title="Péhápkaři.cz Blog RSS" href="/rss.xml">

<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&display=swap&subset=latin-ext" rel="stylesheet">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<link href="/favicon.ico" rel="shortcut icon">

<title>
     Jak posílat e-maily přes Amazon SES | Děláš v PHP? Jsi jedním z nás
</title>

<link rel="stylesheet" href="/build/css/app.86e96c5c.css">

<link rel="stylesheet" href="/assets/prism/prism.css">
<link rel="stylesheet" href="/assets/prism/prism-custom.css">

<link rel="stylesheet" href="https://use.typekit.net/jmg2upk.css">

<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,400i|Ubuntu+Mono&amp;subset=latin-ext" rel="stylesheet">

        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    </head>

    <body id="">
        <nav id="ph-nav" class="navbar fixed-top navbar-expand navbar-light bg-light ph-nav border-bottom hidden-sm-down">
    <div class="container">
        <a class="ph-nav__logo" href="/">
            <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
            <br>
            <p>Péhápkaři</p>
        </a>

        <div id="top-menu-search" class="hidden-md-down">
            <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction">
    <meta itemprop="target" content="https://www.google.com/search?q={q}"/>
    <input name="sitesearch" value="pehapkari.cz" type="hidden"/>
    <input itemprop="query-input" type="text" id="search-query" class="form-control" required="required" name="q" placeholder="Napiš co hledáš..." autocomplete="off"/>
</form>
        </div>

        <ul class="navbar-nav ml-auto hidden-sm-down" id="menu">
            <li>
                <a class="active" href="/blog">
                    Blog
                </a>
            </li>
            <li>
                <a class="" href="/prehaj-si-prednasku">
                    Videa
                </a>
            </li>
            <li class="pr-0">
                <a class="" href="/kontakt">
                    Kontakt
                </a>
            </li>
        </ul>
    </div>
</nav>

<div id="mobile-menu" class="row ml-0 mr-0 text-center hidden-md-up border-bottom">
    <a href="/" class="ph-nav__logo col-3 ">
        <img src="/assets/pehapkari_logo/logo.svg" alt="logo" title="">
    </a>

    <a href="/prehaj-si-prednasku" class="col-3 ">
        Videa
    </a>
    <a href="/blog" class="col-3 ">
        Blog
    </a>
</div>

                    <div id="main">
                

                    <div class="container" id="article">
        <h1>Jak posílat e-maily přes Amazon SES</h1>

        <strong>Petr Jirásek</strong>
        &nbsp;
        <time datetime="2017-03-Mon">
            20. 3. 2017
        </time>

        <br>

        <div class="card mt-4 mb-4">
            <div class="card-body text-bigger">
                <p>Posílat emaily přes Amazon SES je snadné a levné. Zkuste to taky.</p>
            </div>
        </div>

        <h2>Cloudové služby Amazonu</h2>
<p>Amazon Web Services (AWS) je soubor cloudových služeb a stává se čím dál populárnějším řešením jako základ pro infrastrukturu, kterou může využívat vaše aplikace. AWS používá dnes už tolik služeb/webů, že je snad prakticky nemožné používat aspoň jednu službu, která by nebyla se službami Amazonu alespoň nějak propojená.</p>
<p>V tomto článku bych rád ukázal, <strong>jak snadno posílat e-maily</strong> s využitím Amazon SES (Simple Email Service) a jak získat informace o tom, pokud e-mail příjemci není doručen (bounces) nebo je označen jako spam (complaints).</p>
<h2>Prerekvizity</h2>
<p>K tomu, abyste mohli používat služby Amazonu, musíte mít založený účet. Poté už můžete začít nastavovat a používat služby Amazonu.</p>
<p>Jakmile aktivujete Amazon SES, je samozřejmě ještě před prvními testy nutné si verifikovat doménu, z které budete chtít e-maily posílat, poté ideálně nastavit <a href="https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail">DKIM</a>, <a href="https://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> záznamy apod.</p>
<p>Více o tom naleznete <a href="http://docs.aws.amazon.com/ses/latest/DeveloperGuide/setting-up-email.html">zde</a>. V případě, že byste chtěli SES použít a nebyli si jisti, jak nastavit na straně Amazonu, klidně mi napište.</p>
<h2>Jak posílat e-maily</h2>
<p>A teď už k posílání e-mailů. Emaily můžete posílat dvěma způsoby. Buď s využitím SMTP serveru nebo skrze AWS SDK.</p>
<h3>SMTP</h3>
<p>Posílat e-maily přes SMTP je ta nejsnažší varianta. V zásadě vám stačí získat přístupy k SMTP. V <strong>Nette</strong> pak konfigurace může vypadat takto:</p>
<pre><code class="language-php">$options = [
    'host' =&gt; 'email-smtp.eu-west-1.amazonaws.com', // například tento, záleží podle regionu
    'username' =&gt; 'xxx',
    'password' =&gt; 'yyy',
    'secure' =&gt; 'ssl'
    'persistent' =&gt; true,
];

$message = new \Nette\Mail\Message();
$message-&gt;setFrom('odesilatel@example.com', 'Název odesilatele')
    -&gt;addTo('prijemce@example.com')
    -&gt;setSubject('PHP Předmět')
    -&gt;setHtmlBody('Máme rádi PHP!');

$smtpMailer = new \Nette\Mail\SmtpMailer($options);
$smtpMailer-&gt;send($message);</code></pre>
<p>Obdobně byste nastavili odesílání e-mailů i kdybyste odesílali e-maily přes SparkPost, Mailgun a další služby. V zásadě všechny tyto služby vám dají přístupy k SMTP serveru a ty jen nastavíte.</p>
<p>Tohle řešení je pohodlné hlavně proto, že prakticky <strong>nemusíte řešit rozdílnost API</strong> jednotlivých poskytovatelů a přepnout je mezi sebou, když by bylo potřeba, není žádná překážka.</p>
<h3>AWS SDK pro PHP</h3>
<p>Místo posílání e-mailů s využitím SMTP můžete použít i SDK od Amazonu a posílat e-maily přes API. Toto řešení má minimálně dvě výhody - propustnost při odesílání e-mailů je větší než v případě využití SMTP a ke každému e-mailu vám API vrátí navíc identifikátor přiřazený k dané zprávě.</p>
<p>Instalaci AWS SDK můžete provést přes Composer takto:</p>
<pre><code class="language-bash">composer require aws/aws-sdk-php</code></pre>
<p>V AWS si pak vytvoříte uživatele, který bude mít oprávnění pracovat se službami SES skrze API a vygenerujete tak přístupové údaje, které se pak použijí při konfiguraci.</p>
<pre><code class="language-php">$options = [
   'region' =&gt; 'eu-west-1', // závisí na vybraném regionu
   'version' =&gt; 'latest', // verze API
   'credentials' =&gt; [
       'key' =&gt; 'xxx', // vygeneruje se v IAM
       'secret' =&gt; 'yyy' // vygeneruje se v IAM
]];

$sesClient = new \Aws\Ses\SesClient($options);

$request = [];
$request['Source'] = 'odesilatel@example.com';
$request['Destination']['ToAddresses'] = ['prijemce@example.com'];
$request['Message']['Subject']['Data'] = 'PHP Předmět';
$request['Message']['Body']['Html']['Data'] = 'Máme rádi PHP!';
$request['Message']['Body']['Text']['Data'] = 'Máme rádi PHP textově!';

try {
    $result = $sesClient-&gt;sendEmail($request);
    $messageId = $result-&gt;get('MessageId'); // vrátí id e-mailu
} catch (\Aws\Ses\Exception\SesException $e) {
    // když se nepodaří e-mail odeslat
}</code></pre>
<p>Podle mých testů <strong>propustnost posílání e-mailů přes API je větší než přes SMTP</strong>, proto pokud vám jde o to zvládnout v co nejkratším čase poslat co nejvíce e-mailů, může vám použití API pomoci.</p>
<p>Jako další výhodu vidím, že dostanete ke každé zprávě přiřazený unikátní identifikátor, který lze pak použít, pokud chcete sledovat, zda byl e-mail doručen, zda se jednalo o bounce apod.</p>
<h2>Jak získat feedback</h2>
<p>Abyste byli schopni udržet dobrou reputaci vaší databáze, je potřeba <strong>odhlašovat kontakty</strong>, kterým kupříkladu nelze doručit e-mail, jejich e-mailová adresa je falešná nebo vás příjemce označí jako spam (tj. mimo jiné o vaše e-maily nemá pravděpodobně dále zájem) apod.</p>
<p>Proto je vhodné propojit SES s SNS (Simple Notification Service) a SQS (Simple Queue Service). Odkaz, jak nastavit, najdete na konci článku ve zdrojích. Každopádně jde o to, že zprávy o bounces a complaints budou končit ve frontách v SQS, odkud si je budete, třeba cronem, pravidelně stahovat a zpracovávat.</p>
<p>Níže je ukázka kódu, kde z fronty <strong>queue-bounces</strong>, kterou jsem si vytvořil a nastavil, aby tam Amazon posílal bounces, stahuji záznamy. Zpravidla budete na záznamy reagovat tím, že uživatele odhlásíte, tj. vypnete mu příjem e-mailů, smažete jej z listu příjemců apod.</p>
<pre><code class="language-php">// 1. inicializace SQS klienta
$options = [
   'region' =&gt; 'eu-west-1', // závisí na vybraném regionu
   'version' =&gt; 'latest', // verze API
   'credentials' =&gt; [
       'key' =&gt; 'xxx', // vygeneruje se v IAM
       'secret' =&gt; 'yyy' // vygeneruje se v IAM
]];

$sqsClient = new \Aws\Sqs\SqsClient($options);

// 2. získat URL fronty
$urlResult = $sqsClient-&gt;getQueueUrl(['QueueName' =&gt; 'queue-bounces']);
$queueUrl = $urlResult-&gt;get('QueueUrl');

// 3. vrátí zprávy z fronty
$queueResult = $sqsClient-&gt;receiveMessage([
    'QueueUrl' =&gt; $queueUrl,
    'MaxNumberOfMessages' =&gt; 10
]);

if ($queueResult['Messages'] == null) {
    return;
}

// 4.
foreach ($queueResult['Messages'] as $message) {
    $receiptHandle = $message['ReceiptHandle'];
    $body = \Nette\Utils\Json::decode($message['Body']);
    $messageContent = \Nette\Utils\Json::decode($body-&gt;Message);

    if (isset($messageContent-&gt;mail)) {
        foreach ($messageContent-&gt;mail-&gt;destination as $email) {
            // 5. zde se odhlásí uživatel
        }
    }

    // 6. zprávu jsme zpracovali a odstraníme z fronty
    $sqsClient-&gt;deleteMessage([
        'QueueUrl' =&gt; $queueUrl,
        'ReceiptHandle' =&gt; $receiptHandle
    ]);
}</code></pre>
<p>Postup je jednoduchý:</p>
<ol>
<li>Inicializujete SQS klienta.</li>
<li>Získáte URL fronty.</li>
<li>Zavoláte frontu, abyste z ní získali položky ke zpracování.</li>
<li>Projdete jednotlivé zprávy, kde <strong>ReceiptHandle</strong> je ID položky ve frontě a v těle položky najdete samotnou zprávu. Příklad zprávy je uveden níže v JSON.</li>
<li>Zareagujete na událost - můžete třeba odhlásit uživatele podle e-mailu nebo podle messageId, pokud evidujete.</li>
<li>Položku jsme zpracovali a z fronty smažeme.</li>
</ol>
<p>Příklad reálné zprávy (všimněte si, že k dispozici je <strong>messageId</strong>, které také vrací API při odeslání e-mailu):</p>
<pre><code class="language-javascript">{
   "notificationType":"Bounce",
   "bounce":{
      "bounceType":"Permanent",
      "bounceSubType":"General",
      "bouncedRecipients":[
         {
            "emailAddress":"nejakyEmailNaSeznamu@seznam.cz",
            "action":"failed",
            "status":"5.1.1",
            "diagnosticCode":"smtp; 550 5.1.1 Sorry, no mailbox here by that name."
         }
      ],
      "timestamp":"2017-02-24T15:15:06.373Z",
      "feedbackId":"0102015a759b6f37-33adac0e-1d47-4a7a-a053-607e21a660fa-000000",
      "remoteMtaIp":"77.75.76.42",
      "reportingMTA":"dsn; a3-5.smtp-out.eu-west-1.amazonses.com"
   },
   "mail":{
      "timestamp":"2017-02-25T14:10:02.000Z",
      "source":"odesilatel@example.com",
      "sourceArn":"arn:aws:ses:eu-west-1:798010509261:identity/example.com",
      "sendingAccountId":"123456789",
      "messageId":"0102015a759b62be-d7e7e1b4-1cdc-4e89-8357-4873cb19f246-000000",
      "destination":[
         "nejakyEmailNaSeznamu@seznam.cz"
      ]
   }
}</code></pre>
<p>A to je celá věda. Zpravidla se používají dvě fronty, jedna pro bounces, druhá pro complaints.</p>
<h2>Zkušenosti</h2>
<p>Posílání e-mailů přes Amazon je <strong>jednoduché a levné</strong> v porovnání s jinými službami podobného typu. Ty sice často nabízí nějaký pokročilejší logging, ale to často stejně málokdo využije (aspoň co jsem viděl u pár firem).</p>
<p>Na produkci mám zkušenost s AWS SES třeba u <a href="https://www.tipli.cz/">Tipli.cz</a>, kde s tím není žádný problém. Navíc používáme oba způsoby odesílání e-mailů, jak přes SMTP, tak přes SDK. Pro notifikace se používá SMTP, pro newslettery, kde je důležitá rychlost odeslání velkého počtu e-mailů v krátkém časovém okně, se používá SDK.</p>
<p>Pokud vás cokoliv zajímá nebo zvažujete použití SES (a jeho reálné náklady), rád případně zodpovím. Ve článku jsem moc nechtěl probírat nastavení v Amazonu, protože si myslím, že to není tak složité. Kdyby bylo, stačí mi napsat, rád pomůžu, případně se podívejte na odkazy níže, kde jsem se snažil vybrat ty, které vám pomohou doplnit tyto informace.</p>
<h2>Odkazy</h2>
<p>Zde uvádím ještě pár odkazů relevantních k problematice výše.</p>
<ul>
<li><a href="http://docs.aws.amazon.com/ses/latest/DeveloperGuide/Welcome.html">Amazon SES</a> - SES pro developery a kompletní kuchařka.</li>
<li><a href="http://docs.aws.amazon.com/ses/latest/DeveloperGuide/sending-email.html">Jak posílat e-maily s odkazy na nastavení</a> - jak posílat e-maily, jaké jsou možnosti.</li>
<li><a href="https://github.com/aws/aws-sdk-php">AWS SDK pro PHP</a> - AWS SDK pro PHP na Githubu.</li>
<li><a href="https://www.youtube.com/watch?v=9I5EkSNsKnk">Video: Jak nastavit Amazon SES</a> - video o tom, jak nastavit SES na Amazonu.</li>
<li><a href="https://aws.amazon.com/blogs/ses/handling-bounces-and-complaints/">Propojení SES, SNS a SQS</a> - jak nastavit sbírání bounces a complaints, jak propojit SES, SNS a SQS.</li>
</ul>

        <br>

        <div class="container">
            <div id="disqus_thread"></div>

<script type="text/javascript">
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//pehapkari.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        </div>

        <br>
    </div>

            </div>
        
        <div id="footer">
    <div class="container">
        <div class="row">
            <div class="col-12 col-md-6 mt-3 mt-md-0">
                <p class="mb-2">Web Péhápkaři.cz pohání <a href="https://symfony.com/">Symfony</a> a najdeš ho na <a href="https://github.com/pehapkari/pehapkari.cz">Githubu</a>.</p>

                                            </div>

            <div class="col-12 col-md-6 mt-4 mt-md-0">
                <ul id="socials" class="pull-right">
                    <li>
                        <a href="https://facebook.com/pehapkari">
                            <em class="fab fa-2x fa-facebook"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://twitter.com/pehapkari">
                            <em class="fab fa-2x fa-twitter"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/friends-of-php-prague/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Praha</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://meetup.com/Pehapkari-Brno/">
                            <em class="fab fa-2x fa-meetup"></em>
                            <p>Brno</p>
                        </a>
                    </li>

                    <li>
                        <a href="https://github.com/pehapkari">
                            <em class="fab fa-2x fa-github"></em>
                        </a>
                    </li>

                    <li>
                        <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ">
                            <em class="fab fa-2x fa-slack"></em>
                        </a>
                        <p>
                            <a href="https://join.slack.com/t/pehapkari/shared_invite/zt-b5kiu8w2-iqDCp8btryFmXeKiL21fXQ/">
                                <span class="hidden-sm-down">Pozvi se</span>
                                <span class="hidden-md-up">Pozvi</span>
                            </a>
                        </p>
                    </li>
                </ul>
            </div>
        </div>

        <div id="footer_body">
            <div class="row">
                <div class="col-6 col-md-4 mb-4 mb-md-0">
                    <h3>O nás</h3>

                    <ul class="bottom_menu">
                        <li>
                            <a href="/kontakt">Kontakt</a>
                        </li>

                        <li>
                            <a href="/for-speakers">Pro speakry</a>
                        </li>

                        <li>
                            <a href="https://github.com/pehapkari/pehapkari.cz/tree/master/public/assets/pehapkari_logo">Logo</a>
                        </li>

                        <li>
                            <a href="/rss.xml">RSS blogu</a>
                        </li>

                        <li>
                            <a href="http://bit.ly/pehapkari-newsletter">Sleduj Newsletter</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/build/js/app.78e31948.js"></script>

<script
    src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
    crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11"></script>
<script>
    $('document').ready(function() {
        var typed = new Typed('#typed',{
            stringsElement: '#typed-strings',
            typeSpeed: 50,
            backDelay: 1400,
        });
    });
</script>

<script src="/assets/prism/prism.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-89860072-1"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-89860072-1');
</script>
    </body>
</html>
